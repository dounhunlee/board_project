<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>회원가입</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 bg-white p-4 rounded shadow-sm">
            <h2 class="mb-4 text-center">회원가입</h2>

            <form th:action="@{/signup}" method="post" th:object="${user}" id="signupForm">
                <div class="mb-3">
                    <label class="form-label">아이디</label>
                    <div class="input-group">
                        <input type="text" th:field="*{username}" class="form-control" id="username" required>
                        <button type="button" class="btn btn-outline-secondary" id="btnCheck">중복확인</button>
                    </div>

                    <!-- 초기 에러가 있으면 빨간 문구로 렌더 -->
                    <div id="usernameFeedback"
                         class="form-text"
                         th:if="${error}"
                         th:text="${error}"
                         style="display:block; color:#dc3545;"></div>
                    <!-- 에러 없을 땐 비어있는 피드백 박스 준비 -->
                    <div id="usernameFeedbackEmpty" class="form-text" th:if="${error} == null" style="display:none;"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label">비밀번호</label>
                    <input type="password" th:field="*{password}" class="form-control" required autocomplete="new-password">
                </div>

                <div class="mb-3">
                    <label class="form-label">이름</label>
                    <input type="text" th:field="*{name}" class="form-control" required>
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-primary" id="btnSubmit">가입하기</button>
                </div>
            </form>

            <div class="mt-3 text-center">
                <a th:href="@{/login}" class="text-decoration-none">이미 계정이 있으신가요? 로그인</a>
            </div>
        </div>
    </div>
</div>

<script>
    const $username = document.getElementById('username');
    const $btnCheck = document.getElementById('btnCheck');
    const $form = document.getElementById('signupForm');


    let $feedback = document.getElementById('usernameFeedback') || document.getElementById('usernameFeedbackEmpty');
    if ($feedback) { $feedback.id = 'usernameFeedback'; }

    let didCheck = false;
    let lastCheckedValue = '';
    let lastAvailable = false;

    function showFeedback(msg, ok) {
      // ok=true 초록 / false 빨강
      $feedback.style.display = 'block';
      $feedback.textContent = msg;
      // Bootstrap 기본 색상을 직접 사용
      $feedback.classList.remove('text-danger', 'text-success');
      if (ok) {
        $feedback.classList.add('text-success');
      } else {
        $feedback.classList.add('text-danger');
      }
    }

    // 아이디 바뀌면 확인 상태 초기화 + 피드백 숨김
    $username.addEventListener('input', () => {
      didCheck = false;
      lastCheckedValue = '';
      lastAvailable = false;
      if ($feedback) {
        $feedback.style.display = 'none';
        $feedback.textContent = '';
        $feedback.classList.remove('text-danger', 'text-success');
      }
    });

    // 중복확인
    $btnCheck.addEventListener('click', async () => {
      const v = $username.value.trim();
      if (!v) {
        alert('아이디를 입력해 주세요!');
        $username.focus();
        return;
      }
      try {
        const resp = await fetch('/signup/check', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: new URLSearchParams({ username: v })
        });
        const data = await resp.json(); // {exists: true/false}

        didCheck = true;
        lastCheckedValue = v;
        lastAvailable = !data.exists;

        if (data.exists) {
          alert('이미 사용 중입니다 !');
          showFeedback('이미 사용 중인 아이디입니다 !', false); // 빨강
        } else {
          alert('사용 가능한 아이디 입니다.');
          showFeedback('사용 가능한 아이디 입니다.', true); // 초록
        }
      } catch (e) {
        alert('중복확인 중 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.');
      }
    });

    // 제출 전 강제 검증
    $form.addEventListener('submit', (e) => {
      const v = $username.value.trim();
      if (!didCheck) {
        e.preventDefault();
        alert('중복확인을 해주세요 !');
        return;
      }
      if (v !== lastCheckedValue) {
        e.preventDefault();
        alert('아이디가 변경되었습니다. 다시 중복확인을 해주세요 !');
        return;
      }
      if (!lastAvailable) {
        e.preventDefault();
        alert('이미 사용 중인 아이디 입니다.');
        showFeedback('이미 사용 중인 아이디 입니다.', false);
        return;
      }
    });


</script>
<!-- 가입 성공 시 alert 띄우고 로그인으로 이동 -->
<script th:if="${success}" th:inline="javascript">
    alert('가입이 완료되었습니다!');
    // 뒤로가기로 폼 재전송 방지: replace 사용
    window.location.replace(/*[[@{/login}]]*/ '/login');
</script>

</body>
</html>
